<!DOCTYPE html>
<html lang="hy">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>’é’°’∂’°’±’∏÷Ä | ‘ª’¥ ’ä÷Ä’∏÷Ü’´’¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --teal-deep: #006f60;
        --teal-dark: #005b63;
        --white: #ffffff;
        --dark-gray: #2f2f2f;
        --status-resolved: #4caf50; /* Green */
        --status-canceled: #f44336; /* Red */
        --status-pending: #ff9800; /* Orange */
        --status-in-progress: #2196f3; /* Blue */
        --status-completed: #4caf50; /* Green */
      }

      /* Status Badge Styles */
      .status-pending {
        background-color: var(--status-pending);
        color: white;
      }
      .status-completed {
        background-color: var(--status-completed);
        color: white;
      }
      .status-canceled {
        background-color: var(--status-canceled);
        color: white;
      }
      .status-resolved {
        background-color: var(--status-resolved);
        color: white;
      }
      .status-in-progress {
        background-color: var(--status-in-progress);
        color: white;
      }

      /* Status Indicator Bar Styles (applied to the ::before pseudo-element or a div) */
      .indicator-pending {
        background-color: var(--status-pending);
      }
      .indicator-completed {
        background-color: var(--status-completed);
      }
      .indicator-canceled {
        background-color: var(--status-canceled);
      }
      .indicator-resolved {
        background-color: var(--status-resolved);
      }
      .indicator-in-progress {
        background-color: var(--status-in-progress);
      }

      body::before {
        content: "";
        position: fixed;
        top: -100px;
        left: -100px;
        width: 500px;
        height: 500px;
        background: radial-gradient(
          circle,
          rgba(0, 111, 96, 0.2) 0%,
          transparent 70%
        );
        z-index: -1;
        animation: float 8s ease-in-out infinite;
      }
      body::after {
        content: "";
        position: fixed;
        bottom: -100px;
        right: -100px;
        width: 400px;
        height: 400px;
        background: radial-gradient(
          circle,
          rgba(0, 91, 99, 0.2) 0%,
          transparent 70%
        );
        z-index: -1;
        animation: float 10s ease-in-out infinite reverse;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(20px);
        }
      }
      /* Ensure hidden modal is not displayed but retains layout info if needed */
      .modal-hidden {
        display: none;
      }
    </style>
  </head>

  <body class="bg-gray-50 pt-20 font-['Open Sans']">
    <div class="max-w-6xl mx-auto px-4 mt-6 pb-10">
      <nav
        class="fixed top-0 left-0 right-0 z-50 px-6 py-4 flex justify-between items-center bg-white shadow"
      >
        <a
          href="/"
          class="text-xl font-bold text-[color:var(--teal-deep)]"
          aria-label="Go to homepage"
        >
          ’é’°’∂’°’±’∏÷Ä ‚Ä¢ ‘ª’¥ ’ä÷Ä’∏÷Ü’´’¨
        </a>
      </nav>

      <header class="text-center mb-10">
        <h2 class="text-3xl font-bold text-[color:var(--teal-deep)] mb-2">
          ‘ª’¥ ‘ª÷Ä’°’§’°÷Ä’±’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä ÷á ‘Ω’∂’§’´÷Ä’∂’•÷Ä
        </h2>
        <p class="text-md text-gray-600">
          ‘¥’´’ø’•÷Ñ ’±’•÷Ä ’Ø’∏’≤’¥’´÷Å ’∞’°’≤’∏÷Ä’§’æ’°’Æ ’´÷Ä’°’§’°÷Ä’±’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’∂ ’∏÷Ç ’≠’∂’§’´÷Ä’∂’•÷Ä’®÷â
        </p>
      </header>

      <div class="flex justify-center space-x-4 mb-8" role="tablist">
        <button
          id="showEventsBtn"
          class="px-4 py-2 bg-[color:var(--teal-deep)] text-white rounded-full shadow hover:bg-teal-700 transition duration-200"
          aria-selected="true"
          aria-controls="eventsSection"
          role="tab"
        >
          ‘ª÷Ä’°’§’°÷Ä’±’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä
        </button>
        <button
          id="showIssuesBtn"
          class="px-4 py-2 bg-gray-300 text-gray-700 rounded-full shadow hover:bg-gray-400 transition duration-200"
          aria-selected="false"
          aria-controls="issuesSection"
          role="tab"
        >
          ‘Ω’∂’§’´÷Ä’∂’•÷Ä
        </button>
      </div>

      <section
        id="eventsSection"
        class="space-y-6"
        aria-labelledby="showEventsBtn"
        role="tabpanel"
      >
        {% if events %} {% for event in events %}
        <div
          class="bg-white p-6 rounded-2xl shadow-lg relative overflow-hidden"
          data-aos="fade-up"
        >
          <div
            class="w-2 h-full indicator-{{ event.status | lower | replace(' ', '-') }} absolute left-0 top-0 "
            aria-hidden="true"
          ></div>
          <div class="pl-4">
            <h3 class="text-xl font-semibold text-gray-800 mb-2">
              {{ event.title }}
            </h3>
            <p class="text-gray-600 mb-4">{{ event.description }}</p>
            <div
              class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-500 mb-4"
            >
              <div>
                <span aria-hidden="true">üìç</span> {{ event.location_description
                }}
              </div>
              <div>
                <span aria-hidden="true">üìÖ</span> {{ event.date }} {% if
                event.datetime %}({{ event.datetime.split(" ")[1] }}){% endif %}
              </div>
              {% if event.duration %}
              <div><span aria-hidden="true">‚è±Ô∏è</span> {{ event.duration }}</div>
              {% endif %}
            </div>

            <div class="mb-4 text-sm font-semibold">
              <span
                class="px-3 py-1 rounded-full text-xs {{ 'status-' + (event.status | lower | replace(' ', '-')) }}"
              >
                {{ event.status | capitalize }}
              </span>
              <span class="sr-only">Status: {{ event.status }}</span>
            </div>

            <div class="flex flex-wrap gap-3 mb-4">
              <button
                class="flex items-center space-x-2 px-4 py-2 text-sm bg-[color:var(--teal-deep)] hover:bg-teal-700 text-white rounded-full shadow transition duration-200"
                onclick="openEditModal('event', '{{ event._id }}', '{{ event.title }}', '{{ event.description }}', '{{ event.location_description | e }}')"
              >
                <img
                  src="https://img.icons8.com/material-outlined/24/ffffff/edit.png"
                  alt="Edit"
                  class="w-4 h-4"
                />
                <span>‘Ω’¥’¢’°’£÷Ä’•’¨</span>
              </button>

              <form
                action="/profile/events/{{ event._id }}/delete"
                method="post"
                onsubmit="return confirm('’é’Ω’ø’°’û’∞ ’•÷Ñ, ’∏÷Ä ’∏÷Ç’¶’∏÷Ç’¥ ’•÷Ñ ’ª’∂’ª’•’¨ ’°’µ’Ω ’´÷Ä’°’§’°÷Ä’±’∏÷Ç’©’µ’∏÷Ç’∂’®÷â\nAre you sure you want to delete this event?')"
                class="inline-block"
              >
                <button
                  type="submit"
                  class="flex items-center space-x-2 px-4 py-2 text-sm bg-red-600 hover:bg-red-700 text-white rounded-full shadow transition duration-200"
                >
                  <img
                    src="https://img.icons8.com/material-outlined/24/ffffff/trash.png"
                    alt="Delete"
                    class="w-4 h-4"
                  />
                  <span>’ã’∂’ª’•’¨</span>
                </button>
              </form>
            </div>

            {% if event.photo and event.photo != "None" and event.photo !=
            "/files/None" %}
            <img
              src="{{ event.photo }}"
              class="w-full max-w-sm rounded-lg mt-4 shadow"
              alt="Event Photo"
              loading="lazy"
            />
            {% endif %} {% if event.video and event.video != "None" and
            event.video != "/files/None" %}
            <video
              controls
              class="w-full max-w-sm rounded-lg mt-4 shadow"
              aria-label="Event Video"
              preload="metadata"
            >
              <source src="{{ event.video }}" type="video/mp4" />
              Your browser does not support the video tag.
            </video>
            {% endif %}
          </div>
        </div>
        {% endfor %} {% else %}
        <div class="text-center py-20">
          <p class="text-lg font-medium text-gray-600">
            ‘¥’∏÷Ç÷Ñ ’§’•’º ’´÷Ä’°’§’°÷Ä’±’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä ’π’•÷Ñ ’∞’°’≤’∏÷Ä’§’•’¨÷â
          </p>
          <a
            href="/create_event"
            class="mt-4 inline-block px-5 py-2 bg-[color:var(--teal-deep)] text-white rounded-full shadow hover:bg-teal-700 transition duration-200"
          >
            ‘±’æ’•’¨’°÷Å’∂’•’¨ ‘ª÷Ä’°’§’°÷Ä’±’∏÷Ç’©’µ’∏÷Ç’∂
          </a>
        </div>
        {% endif %}
      </section>

      <section
        id="issuesSection"
        class="space-y-6 hidden"
        aria-labelledby="showIssuesBtn"
        role="tabpanel"
      >
        {% if issues %} {% for issue in issues %}
        <div
          class="bg-white p-6 rounded-2xl shadow-lg relative overflow-hidden"
          data-aos="fade-up"
        >
          <div
            class="w-2 h-full indicator-{{ issue.status | lower | replace(' ', '-') }} absolute left-0 top-0"
            aria-hidden="true"
          ></div>
          <div class="pl-4">
            <h3 class="text-xl font-semibold text-gray-800 mb-2">
              {{ issue.title }}
            </h3>
            <p class="text-gray-600 mb-4">{{ issue.description }}</p>
            <div
              class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-500 mb-4"
            >
              <div>
                <span aria-hidden="true">üìç</span> {{ issue.location_description
                }}
              </div>
              <div>
                <span aria-hidden="true">üìÖ</span> {{ issue.created_at_formatted
                }}
              </div>
            </div>

            <div class="mb-4 text-sm font-semibold">
              <span
                class="px-3 py-1 rounded-full text-xs {{ 'status-' + (issue.status | lower | replace(' ', '-')) }}"
              >
                {{ issue.status | capitalize }}
              </span>
              <span class="sr-only">Status: {{ issue.status }}</span>
            </div>

            <div class="flex flex-wrap gap-3 mb-4">
              <button
                class="flex items-center space-x-2 px-4 py-2 text-sm bg-[color:var(--teal-deep)] hover:bg-teal-700 text-white rounded-full shadow transition duration-200"
                onclick="openEditModal('issue', '{{ issue._id }}', '{{ issue.title }}', '{{ issue.description }}', '{{ issue.location_description | e }}')"
              >
                <img
                  src="https://img.icons8.com/material-outlined/24/ffffff/edit.png"
                  alt="Edit"
                  class="w-4 h-4"
                />
                <span>‘Ω’¥’¢’°’£÷Ä’•’¨</span>
              </button>

              <form
                action="/profile/issues/{{ issue._id }}/delete"
                method="post"
                onsubmit="return confirm('’é’Ω’ø’°’û’∞ ’•÷Ñ, ’∏÷Ä ’∏÷Ç’¶’∏÷Ç’¥ ’•÷Ñ ’ª’∂’ª’•’¨ ’°’µ’Ω ’≠’∂’§’´÷Ä’®÷â\nAre you sure you want to delete this issue?')"
                class="inline-block"
              >
                <button
                  type="submit"
                  class="flex items-center space-x-2 px-4 py-2 text-sm bg-red-600 hover:bg-red-700 text-white rounded-full shadow transition duration-200"
                >
                  <img
                    src="https://img.icons8.com/material-outlined/24/ffffff/trash.png"
                    alt="Delete"
                    class="w-4 h-4"
                  />
                  <span>’ã’∂’ª’•’¨</span>
                </button>
              </form>
            </div>

            {% if issue.photo and issue.photo != "None" and issue.photo !=
            "/files/None" %}
            <div class="mt-4">
              <img
                src="{{ issue.photo }}"
                class="w-full max-w-sm rounded-lg mt-2 shadow"
                alt="Issue Photo"
                loading="lazy"
              />
            </div>
            {% endif %} {% if issue.video and issue.video != "None" and
            issue.video != "/files/None" %}
            <div class="mt-4">
              <video
                controls
                class="w-full max-w-sm mt-2 rounded-lg shadow"
                aria-label="Issue Video"
                preload="metadata"
              >
                <source src="{{ issue.video }}" type="video/mp4" />
                Your browser does not support the video tag.
              </video>
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %} {% else %}
        <div class="text-center py-20">
          <p class="text-lg font-medium text-gray-600">
            ‘¥’∏÷Ç÷Ñ ’§’•’º ’≠’∂’§’´÷Ä’∂’•÷Ä ’π’•÷Ñ ’∞’°’≤’∏÷Ä’§’•’¨÷â
          </p>
          <a
            href="/report-issue"
            class="mt-4 inline-block px-5 py-2 bg-[color:var(--teal-deep)] text-white rounded-full shadow hover:bg-teal-700 transition duration-200"
          >
            ’Ä’°’≤’∏÷Ä’§’•’¨ ‘Ω’∂’§’´÷Ä
          </a>
        </div>
        {% endif %}
      </section>

      <div
        id="editModal"
        class="fixed inset-0 bg-black bg-opacity-60 modal-hidden items-center justify-center z-[100]"
        aria-modal="true"
        role="dialog"
        aria-labelledby="editModalTitle"
      >
        <div
          class="bg-white p-6 rounded-xl w-full max-w-md shadow-xl relative mx-4"
        >
          <button
            onclick="closeEditModal()"
            class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-3xl leading-none"
            aria-label="Close Edit Modal"
          >
            &times;
          </button>

          <h3
            id="editModalTitle"
            class="text-2xl font-bold text-center text-[color:var(--teal-deep)] mb-6"
          >
            ‘Ω’¥’¢’°’£÷Ä’•’¨
          </h3>

          <form id="editForm" method="POST" action="">
            <div class="mb-4">
              <label
                for="editTitle"
                class="block text-gray-700 text-sm font-bold mb-2"
              >
                ’é’•÷Ä’∂’°’£’´÷Ä <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                name="title"
                id="editTitle"
                placeholder="’Ñ’∏÷Ç’ø÷Ñ’°’£÷Ä’•÷Ñ ’æ’•÷Ä’∂’°’£’´÷Ä’®"
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[color:var(--teal-deep)]"
                required
              />
            </div>

            <div class="mb-4">
              <label
                for="editDescription"
                class="block text-gray-700 text-sm font-bold mb-2"
              >
                ’Ü’Ø’°÷Ä’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ <span class="text-red-500">*</span>
              </label>
              <textarea
                name="description"
                id="editDescription"
                rows="4"
                placeholder="’Ñ’∏÷Ç’ø÷Ñ’°’£÷Ä’•÷Ñ ’∂’Ø’°÷Ä’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®"
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[color:var(--teal-deep)]"
                required
              ></textarea>
            </div>

            <div class="mb-6">
              <label
                for="editLocation"
                class="block text-gray-700 text-sm font-bold mb-2"
              >
                ‘≥’ø’∂’æ’•’¨’∏÷Ç ’æ’°’µ÷Ä’´ ’∂’Ø’°÷Ä’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂
                <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                name="location_description"
                id="editLocation"
                placeholder="’Ñ’∏÷Ç’ø÷Ñ’°’£÷Ä’•÷Ñ ’£’ø’∂’æ’•’¨’∏÷Ç ’æ’°’µ÷Ä’´ ’∂’Ø’°÷Ä’°’£÷Ä’∏÷Ç’©’µ’∏÷Ç’∂’®"
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[color:var(--teal-deep)]"
                required
              />
            </div>

            <button
              type="submit"
              class="w-full bg-[color:var(--teal-deep)] hover:bg-teal-700 text-white py-2.5 rounded-lg font-semibold transition duration-200"
            >
              ’ä’°’∞’∫’°’∂’•’¨ ’ì’∏÷É’∏’≠’∏÷Ç’©’µ’∏÷Ç’∂’∂’•÷Ä’®
            </button>
          </form>
        </div>
      </div>
    </div>
    <script>
      AOS.init({
        duration: 600, // Animation duration
        once: true, // Only animate elements once
      });

      const showIssuesBtn = document.getElementById("showIssuesBtn");
      const showEventsBtn = document.getElementById("showEventsBtn");
      const issuesSection = document.getElementById("issuesSection");
      const eventsSection = document.getElementById("eventsSection");
      const editModal = document.getElementById("editModal");
      const editForm = document.getElementById("editForm");
      const editModalTitle = document.getElementById("editModalTitle");

      // Function to switch tabs
      function switchTab(tabToShow, tabToHide, btnToActivate, btnToDeactivate) {
        tabToShow.classList.remove("hidden");
        tabToHide.classList.add("hidden");

        btnToActivate.classList.add(
          "bg-[color:var(--teal-deep)]",
          "text-white"
        );
        btnToActivate.classList.remove("bg-gray-300", "text-gray-700");
        btnToActivate.setAttribute("aria-selected", "true");

        btnToDeactivate.classList.add("bg-gray-300", "text-gray-700");
        btnToDeactivate.classList.remove(
          "bg-[color:var(--teal-deep)]",
          "text-white"
        );
        btnToDeactivate.setAttribute("aria-selected", "false");
      }

      // Event listeners for tabs
      showEventsBtn.addEventListener("click", () => {
        switchTab(eventsSection, issuesSection, showEventsBtn, showIssuesBtn);
      });

      showIssuesBtn.addEventListener("click", () => {
        switchTab(issuesSection, eventsSection, showIssuesBtn, showEventsBtn);
      });

      // --- MODAL LOGIC ---
      function openEditModal(type, id, title, description, locationDesc) {
        if (!editModal || !editForm || !editModalTitle) {
          console.error("Modal components not found!");
          return;
        }

        console.log(`Opening modal for ${type} with ID: ${id}`); // Debug log

        // Decode HTML entities that might be in the passed strings (e.g., from Jinja's |e filter)
        const decodeHtml = (html) => {
          const txt = document.createElement("textarea");
          txt.innerHTML = html;
          return txt.value;
        };

        // Populate form fields
        document.getElementById("editTitle").value = decodeHtml(title);
        document.getElementById("editDescription").value =
          decodeHtml(description);
        // Use locationDesc for the input with id="editLocation" (which has name="location_description")
        document.getElementById("editLocation").value =
          decodeHtml(locationDesc);

        // Set form action and modal title based on type
        if (type === "event") {
          editForm.action = `/profile/events/${id}/edit`;
          editModalTitle.textContent = "‘Ω’¥’¢’°’£÷Ä’•’¨ ‘ª÷Ä’°’§’°÷Ä’±’∏÷Ç’©’µ’∏÷Ç’∂’®"; // Edit Event
        } else if (type === "issue") {
          editForm.action = `/profile/issues/${id}/edit`;
          editModalTitle.textContent = "‘Ω’¥’¢’°’£÷Ä’•’¨ ‘Ω’∂’§’´÷Ä’®"; // Edit Issue
        } else {
          console.error("Unknown type passed to openEditModal:", type);
          closeEditModal(); // Close modal if type is wrong
          return;
        }

        // Show the modal using flex for centering
        editModal.classList.remove("modal-hidden");
        editModal.classList.add("flex");
        // Optional: Trap focus within the modal for accessibility
        // setupFocusTrap(editModal);
      }

      function closeEditModal() {
        if (editModal) {
          editModal.classList.add("modal-hidden");
          editModal.classList.remove("flex");
          // Optional: Remove focus trap
          // removeFocusTrap();
        }
      }

      // Close modal if clicked outside the content area
      editModal.addEventListener("click", (event) => {
        // Check if the click is directly on the modal background
        if (event.target === editModal) {
          closeEditModal();
        }
      });

      // Close modal on Escape key press
      document.addEventListener("keydown", (event) => {
        if (
          event.key === "Escape" &&
          !editModal.classList.contains("modal-hidden")
        ) {
          closeEditModal();
        }
      });

      // --- Accessibility Enhancements (Optional but Recommended) ---
      // Basic Focus Trap Example (Needs more robust implementation for production)
      let focusableElements = [];
      let firstFocusableElement;
      let lastFocusableElement;

      function setupFocusTrap(modalElement) {
        focusableElements = modalElement.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        firstFocusableElement = focusableElements[0];
        lastFocusableElement = focusableElements[focusableElements.length - 1];
        firstFocusableElement?.focus(); // Focus the first element when modal opens

        modalElement.addEventListener("keydown", trapFocus);
      }

      function removeFocusTrap() {
        editModal.removeEventListener("keydown", trapFocus);
      }

      function trapFocus(event) {
        if (event.key !== "Tab") {
          return;
        }

        if (event.shiftKey) {
          // Shift + Tab
          if (document.activeElement === firstFocusableElement) {
            lastFocusableElement.focus();
            event.preventDefault();
          }
        } else {
          // Tab
          if (document.activeElement === lastFocusableElement) {
            firstFocusableElement.focus();
            event.preventDefault();
          }
        }
      }
    </script>
  </body>
</html>
