<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Report Issue - Rockville, Maryland</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      :root {
        --primary-blue: #1e40af;
        --secondary-blue: #3b82f6;
        --accent-gold: #f59e0b;
        --dark-blue: #1e3a8a;
        --light-blue: #dbeafe;
        --white: #ffffff;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-600: #4b5563;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1),
          0 8px 10px -6px rgb(0 0 0 / 0.1);
      }

      .dark {
        --primary-blue: #3b82f6;
        --secondary-blue: #60a5fa;
        --accent-gold: #fbbf24;
        --dark-blue: #1e40af;
        --light-blue: #1e3a8a;
        --white: #111827;
        --gray-50: #1f2937;
        --gray-100: #374151;
        --gray-200: #4b5563;
        --gray-300: #6b7280;
        --gray-600: #9ca3af;
        --gray-800: #e5e7eb;
        --gray-900: #f9fafb;
      }

      body {
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .hero-gradient {
        background: linear-gradient(
          135deg,
          var(--primary-blue) 0%,
          var(--secondary-blue) 50%,
          var(--accent-gold) 100%
        );
      }

      .glass-effect {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .animate-float {
        animation: float 6s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-20px);
        }
      }

      .text-gradient {
        background: linear-gradient(
          135deg,
          var(--primary-blue),
          var(--accent-gold)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-10px);
        box-shadow: var(--shadow-xl);
      }

      /* Animated background elements */
      .bg-particle {
        position: fixed;
        border-radius: 50%;
        background: linear-gradient(
          45deg,
          rgba(30, 64, 175, 0.1),
          rgba(245, 158, 11, 0.1)
        );
        z-index: -1;
        animation: particleFloat 15s infinite linear;
      }

      .particle-1 {
        width: 200px;
        height: 200px;
        top: 10%;
        left: -5%;
        animation-delay: 0s;
      }

      .particle-2 {
        width: 150px;
        height: 150px;
        bottom: 20%;
        right: -3%;
        animation-delay: 5s;
      }

      .particle-3 {
        width: 100px;
        height: 100px;
        top: 60%;
        left: 80%;
        animation-delay: 10s;
      }

      @keyframes particleFloat {
        0% {
          transform: translate(0, 0) rotate(0deg) scale(1);
          opacity: 0.3;
        }
        25% {
          transform: translate(50px, -50px) rotate(90deg) scale(1.1);
          opacity: 0.5;
        }
        50% {
          transform: translate(0, -100px) rotate(180deg) scale(1);
          opacity: 0.3;
        }
        75% {
          transform: translate(-50px, -50px) rotate(270deg) scale(0.9);
          opacity: 0.4;
        }
        100% {
          transform: translate(0, 0) rotate(360deg) scale(1);
          opacity: 0.3;
        }
      }

      .form-container {
        background: var(--white);
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15),
          0 0 0 1px rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(20px);
        position: relative;
        overflow: hidden;
      }

      .form-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(
          90deg,
          var(--primary-blue),
          var(--accent-gold)
        );
      }

      .form-section {
        padding: 2rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .form-section:last-child {
        border-bottom: none;
      }

      .form-section:hover {
        background: rgba(30, 64, 175, 0.02);
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
      }

      .input-icon {
        position: absolute;
        left: 1rem;
        z-index: 10;
        color: var(--primary-blue);
        font-size: 1.1rem;
      }

      .form-input {
        width: 100%;
        padding: 1rem 1rem 1rem 3rem;
        border: 2px solid transparent;
        border-radius: 12px;
        background: var(--gray-200);
        font-size: 1rem;
        transition: all 0.3s ease;
        color: var(--gray-900);
      }

      .form-input:focus {
        outline: none;
        border-color: var(--primary-blue);
        background: var(--white);
        box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
        transform: translateY(-2px);
      }

      .form-textarea {
        min-height: 120px;
        resize: vertical;
        padding: 1rem;
      }

      .btn-modern {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        font-size: 1rem;
        position: relative;
        overflow: hidden;
      }

      .btn-modern::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .btn-modern:hover::before {
        left: 100%;
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-blue),
          var(--secondary-blue)
        );
        color: var(--white);
      }

      .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(30, 64, 175, 0.3);
      }

      .btn-secondary {
        background: var(--white);
        color: var(--primary-blue);
        border: 2px solid var(--primary-blue);
      }

      .btn-secondary:hover {
        background: var(--primary-blue);
        color: var(--white);
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(30, 64, 175, 0.3);
      }

      .btn-gold {
        background: linear-gradient(135deg, var(--accent-gold), #fbbf24);
        color: var(--gray-900);
      }

      .btn-gold:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
      }

      .file-upload-area {
        border: 2px dashed var(--gray-50);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: var(--gray-200);
      }

      .file-upload-area:hover {
        border-color: var(--primary-blue);
        background: rgba(30, 64, 175, 0.05);
      }

      .file-upload-area.dragover {
        border-color: var(--accent-gold);
        background: rgba(245, 158, 11, 0.1);
        transform: scale(1.02);
      }

      .preview-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
      }

      .preview-item {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 1;
        border: 2px solid var(--gray-200);
        background: var(--white);
        box-shadow: var(--shadow-md);
        transition: all 0.3s ease;
      }

      .preview-item:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-lg);
      }

      .preview-item img,
      .preview-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .remove-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.3s ease;
      }

      .remove-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
      }

      #osm-map {
        height: 400px;
        border-radius: 12px;
        border: 2px solid var(--gray-200);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
      }

      .location-display {
        background: var(--light-blue);
        padding: 1rem;
        border-radius: 12px;
        margin-top: 1rem;
        border-left: 4px solid var(--primary-blue);
      }

      .submit-section {
        background: linear-gradient(135deg, var(--gray-50), var(--white));
        padding: 2rem;
        border-radius: 0 0 20px 20px;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .form-section {
          padding: 1.5rem;
        }

        .preview-container {
          grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        }

        #osm-map {
          height: 300px;
        }
      }

      /* Dark mode adjustments */
      .dark .form-container {
        background: var(--gray-800);
        border-color: var(--gray-700);
      }

      .dark .form-section:hover {
        background: rgba(59, 130, 246, 0.05);
      }

      .dark .form-input {
        background: var(--gray-700);
        color: var(--gray-100);
        border-color: var(--gray-600);
      }

      .dark .form-input:focus {
        background: var(--gray-600);
        border-color: var(--secondary-blue);
      }

      .dark .file-upload-area {
        background: var(--gray-700);
        border-color: var(--gray-600);
      }

      .dark .file-upload-area:hover {
        background: rgba(59, 130, 246, 0.1);
      }

      .dark .location-display {
        background: var(--gray-700);
        color: var(--gray-100);
      }

      .dark .preview-item {
        border-color: var(--gray-600);
        background: var(--gray-700);
      }

      .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body
    class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300"
  >
    <!-- Animated background particles -->
    <div class="bg-particle particle-1"></div>
    <div class="bg-particle particle-2"></div>
    <div class="bg-particle particle-3"></div>

    <!-- Header -->
    <header class="fixed w-full top-0 left-0 z-50 glass-effect">
      <div
        class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between"
      >
        <div class="flex items-center space-x-4">
          <div
            class="w-10 h-10 bg-gradient-to-br from-blue-600 to-yellow-500 rounded-full flex items-center justify-center"
          >
            <i class="fas fa-city text-white text-lg"></i>
          </div>
          <h1 class="text-2xl font-bold text-gradient">Rockville</h1>
        </div>

        <nav class="hidden md:flex items-center space-x-8">
          <a
            href="/"
            class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
            >Home</a
          >
          <a
            href="/about"
            class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
            >About</a
          >
          <a
            href="/contact"
            class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
            >Contact</a
          >
          <a
            href="/news"
            class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
            >News</a
          >
        </nav>

        <div class="flex items-center space-x-4">
          <!-- Dark Mode Toggle -->
          <button
            id="dark-mode-toggle"
            class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
          >
            <i class="fas fa-moon dark:hidden"></i>
            <i class="fas fa-sun hidden dark:block"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Hero Section -->
    <section
      class="relative min-h-[60vh] flex items-center justify-center hero-gradient overflow-hidden mt-20"
    >
      <div class="absolute inset-0 bg-black bg-opacity-40"></div>
      <div class="absolute inset-0">
        <img
          src="https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80"
          alt="Rockville City"
          class="w-full h-full object-cover opacity-30"
        />
      </div>

      <div class="relative z-10 text-center text-white px-6 max-w-4xl mx-auto">
        <h1 class="text-4xl md:text-6xl font-bold mb-6 animate-float">
          Report an <span class="text-yellow-400">Issue</span>
        </h1>
        <p class="text-lg md:text-xl mb-8 text-gray-200">
          Help us improve Rockville by reporting issues you encounter in our
          community. Your report helps make our city better for everyone.
        </p>
      </div>
    </section>

    <!-- Main Form Container -->
    <section class="py-20 bg-gray-50 dark:bg-gray-900">
      <div class="max-w-4xl mx-auto px-6">
        <!-- Official Header -->
        <div class="form-container mb-8">
          <div
            class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-8 rounded-t-20"
          >
            <div class="flex items-center justify-between flex-wrap gap-4">
              <div class="flex items-center space-x-4">
                <div
                  class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center backdrop-blur-sm"
                >
                  <i class="fas fa-city text-2xl"></i>
                </div>
                <div>
                  <h2 class="text-2xl font-bold">City of Rockville</h2>
                  <p class="text-blue-100">Help us improve our community</p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-sm text-blue-100">Report Portal</p>
                <p class="text-lg font-semibold">Maryland</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Report Form -->
        <form
          id="issueForm"
          class="form-container"
          action="/report/"
          method="POST"
          enctype="multipart/form-data"
        >
          <!-- Issue Details Section -->
          <div class="form-section">
            <h3 class="text-2xl font-bold text-gradient mb-6 flex items-center">
              <i class="fas fa-exclamation-triangle mr-3"></i>
              Issue Details
            </h3>

            <div class="form-group">
              <label
                for="title"
                class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
              >
                Issue Title *
              </label>
              <div class="input-wrapper">
                <i class="fas fa-heading input-icon"></i>
                <input
                  type="text"
                  id="title"
                  name="title"
                  class="form-input"
                  placeholder="Briefly describe the issue"
                  required
                />
              </div>
            </div>

            <div class="form-group">
              <label
                for="description"
                class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
              >
                Detailed Description *
              </label>
              <div class="input-wrapper">
                <i class="fas fa-align-left input-icon" style="top: 1rem"></i>
                <textarea
                  id="description"
                  name="description"
                  class="form-input form-textarea"
                  placeholder="Provide a detailed description of the issue, possible solutions, and any additional context..."
                  required
                  style="padding-left: 3rem"
                ></textarea>
              </div>
            </div>

            <div class="mt-4">
              <button
                type="button"
                id="ai-suggest-btn"
                class="btn-modern btn-gold"
              >
                <i class="fas fa-magic mr-2"></i>
                Get AI Suggestions
              </button>
            </div>
          </div>

          <!-- Location Section -->
          Κ
          <div class="form-section">
            <h3 class="text-2xl font-bold text-gradient mb-6 flex items-center">
              <i class="fas fa-map-marker-alt mr-3"></i>
              Location
            </h3>

            <div class="flex flex-wrap gap-4 mb-6">
              <button
                type="button"
                id="useMyLocation"
                class="btn-modern btn-primary"
              >
                <i class="fas fa-location-arrow mr-2"></i>
                Use My Location
              </button>
              <button
                type="button"
                id="selectOnMap"
                class="btn-modern btn-secondary"
              >
                <i class="fas fa-map-pin mr-2"></i>
                Select on Map
              </button>
            </div>

            <div class="grid md:grid-cols-2 gap-4 mb-6">
              <div class="form-group">
                <label
                  for="location"
                  class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
                >
                  Coordinates
                </label>
                <div class="input-wrapper">
                  <i class="fas fa-crosshairs input-icon"></i>
                  <input
                    type="text"
                    id="location"
                    name="location"
                    class="form-input"
                    placeholder="Coordinates will appear here"
                    readonly
                  />
                </div>
              </div>

              <div class="form-group">
                <label
                  for="location-description"
                  class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
                >
                  Location Description
                </label>
                <div class="input-wrapper">
                  <i class="fas fa-info-circle input-icon"></i>
                  <input
                    type="text"
                    id="location-description"
                    name="location_description"
                    class="form-input"
                    placeholder="Street, nearby landmarks..."
                  />
                </div>
              </div>
            </div>

            <div id="osm-map"></div>

            <div
              id="location-display"
              class="location-display"
              style="display: none"
            >
              <div class="flex items-center">
                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                <span class="font-semibold">Location Selected</span>
              </div>
              <p
                class="text-sm text-gray-600 dark:text-gray-400 mt-1"
                id="location-coords"
              ></p>
            </div>
          </div>

          <!-- Media Upload Section -->
          <div class="form-section">
            <h3 class="text-2xl font-bold text-gradient mb-6 flex items-center">
              <i class="fas fa-camera mr-3"></i>
              Media Upload
            </h3>

            <!-- Photo Upload -->
            <div class="form-group">
              <label
                class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
              >
                <i class="fas fa-images mr-2"></i>
                Photos
              </label>
              <input
                type="file"
                id="photo"
                name="photo"
                accept="image/*"
                multiple
                class="hidden"
              />
              <div
                class="file-upload-area"
                onclick="document.getElementById('photo').click()"
              >
                <i
                  class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"
                ></i>
                <p
                  class="text-lg font-semibold text-gray-700 dark:text-gray-300"
                >
                  Upload Photos
                </p>
                <p class="text-sm text-gray-500">
                  Click to select or drag and drop multiple images
                </p>
              </div>
              <div class="preview-container" id="photo-preview"></div>
            </div>

            <!-- Video Upload -->
            <div class="form-group">
              <label
                class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
              >
                <i class="fas fa-video mr-2"></i>
                Video
              </label>
              <input
                type="file"
                id="video"
                name="video"
                accept="video/*"
                class="hidden"
              />
              <div
                class="file-upload-area"
                onclick="document.getElementById('video').click()"
              >
                <i class="fas fa-video text-4xl text-gray-400 mb-4"></i>
                <p
                  class="text-lg font-semibold text-gray-700 dark:text-gray-300"
                >
                  Upload Video
                </p>
                <p class="text-sm text-gray-500">
                  Click to select a video file
                </p>
              </div>
              <div class="preview-container" id="video-preview"></div>
            </div>
          </div>

          <!-- Submit Section -->
          <div class="submit-section">
            <div class="text-center">
              <button
                type="submit"
                id="submit-btn"
                class="btn-modern btn-primary text-lg px-8 py-4 w-full md:w-auto"
              >
                <i class="fas fa-paper-plane mr-2"></i>
                Submit Issue Report
              </button>
              <p class="text-sm text-gray-500 mt-4 max-w-md mx-auto">
                Your report will be reviewed by city officials and you'll
                receive updates on its status.
              </p>
            </div>
          </div>
        </form>

        <!-- Back Button -->
        <div class="text-center mt-8">
          <a href="/" class="btn-modern btn-secondary">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Home
          </a>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12">
      <div class="max-w-7xl mx-auto px-6 text-center">
        <div class="flex items-center justify-center mb-6">
          <div
            class="w-12 h-12 bg-gradient-to-br from-blue-600 to-yellow-500 rounded-full flex items-center justify-center mr-4"
          >
            <i class="fas fa-city text-white text-xl"></i>
          </div>
          <h3 class="text-2xl font-bold">Rockville, Maryland</h3>
        </div>
        <p class="text-gray-400 mb-4">
          Building a better community together through technology and civic
          engagement.
        </p>
        <p class="text-gray-500">
          © <span id="year"></span> Rockville City Portal. All rights reserved.
        </p>
      </div>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Dark mode toggle
      const darkModeToggle = document.getElementById("dark-mode-toggle");
      const html = document.documentElement;

      const currentTheme = localStorage.getItem("theme") || "light";
      html.classList.toggle("dark", currentTheme === "dark");

      darkModeToggle.addEventListener("click", () => {
        html.classList.toggle("dark");
        const theme = html.classList.contains("dark") ? "dark" : "light";
        localStorage.setItem("theme", theme);
      });

      // Initialize map centered on Rockville, MD
      const map = L.map("osm-map").setView([39.084, -77.1528], 13);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      // Custom marker icon
      const customIcon = L.icon({
        iconUrl:
          "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
      });

      let marker;

      // Add marker on map click
      map.on("click", function (e) {
        if (marker) {
          map.removeLayer(marker);
        }
        marker = L.marker(e.latlng, { icon: customIcon }).addTo(map);
        updateLocationDisplay(e.latlng.lat, e.latlng.lng);
      });

      // Update location display
      function updateLocationDisplay(lat, lng) {
        document.getElementById("location").value = `${lat.toFixed(
          6
        )}, ${lng.toFixed(6)}`;
        document.getElementById(
          "location-coords"
        ).textContent = `Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(
          6
        )}`;
        document.getElementById("location-display").style.display = "block";
      }

      // Use current location
      document
        .getElementById("useMyLocation")
        .addEventListener("click", function () {
          const btn = this;
          const originalHtml = btn.innerHTML;

          if (navigator.geolocation) {
            btn.innerHTML =
              '<div class="loading-spinner mr-2"></div> Getting Location...';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
              function (position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                if (marker) {
                  map.removeLayer(marker);
                }

                map.setView([lat, lng], 16);
                marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
                updateLocationDisplay(lat, lng);

                btn.innerHTML = originalHtml;
                btn.disabled = false;
              },
              function (error) {
                alert("Unable to get your location: " + error.message);
                btn.innerHTML = originalHtml;
                btn.disabled = false;
              },
              {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0,
              }
            );
          } else {
            alert("Geolocation is not supported by this browser.");
          }
        });

      // Select on map button
      document
        .getElementById("selectOnMap")
        .addEventListener("click", function () {
          alert("Click anywhere on the map to select the issue location");
          // Optionally scroll to map
          document
            .getElementById("osm-map")
            .scrollIntoView({ behavior: "smooth" });
        });

      // File upload handlers with drag and drop
      function setupFileUpload(inputId, previewId, multiple = false) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const uploadArea =
          input.parentElement.querySelector(".file-upload-area");

        // Handle file selection
        input.addEventListener("change", function (e) {
          handleFiles(e.target.files, preview, multiple);
        });

        // Drag and drop functionality
        uploadArea.addEventListener("dragover", function (e) {
          e.preventDefault();
          uploadArea.classList.add("dragover");
        });

        uploadArea.addEventListener("dragleave", function (e) {
          e.preventDefault();
          uploadArea.classList.remove("dragover");
        });

        uploadArea.addEventListener("drop", function (e) {
          e.preventDefault();
          uploadArea.classList.remove("dragover");
          const files = e.dataTransfer.files;
          handleFiles(files, preview, multiple);

          // Update input files
          input.files = files;
        });
      }

      function handleFiles(files, previewContainer, multiple) {
        if (!multiple) {
          previewContainer.innerHTML = "";
        }

        Array.from(files).forEach((file, index) => {
          const reader = new FileReader();

          reader.onload = function (e) {
            const previewItem = document.createElement("div");
            previewItem.className = "preview-item";

            let mediaElement;
            if (file.type.startsWith("image/")) {
              mediaElement = document.createElement("img");
              mediaElement.src = e.target.result;
              mediaElement.alt = file.name;
            } else if (file.type.startsWith("video/")) {
              mediaElement = document.createElement("video");
              mediaElement.src = e.target.result;
              mediaElement.controls = true;
              mediaElement.muted = true;
            }

            const removeBtn = document.createElement("div");
            removeBtn.className = "remove-btn";
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.addEventListener("click", function () {
              previewItem.remove();
            });

            previewItem.appendChild(mediaElement);
            previewItem.appendChild(removeBtn);
            previewContainer.appendChild(previewItem);
          };

          reader.readAsDataURL(file);
        });
      }

      // Setup file uploads
      setupFileUpload("photo", "photo-preview", true);
      setupFileUpload("video", "video-preview", false);

      // AI Suggestions functionality
      document
        .getElementById("ai-suggest-btn")
        .addEventListener("click", async function () {
          const btn = this;
          const originalHtml = btn.innerHTML;
          const title = document.getElementById("title").value;
          const description = document.getElementById("description").value;

          if (!title && !description) {
            alert(
              "Please enter a title or description first to get AI suggestions."
            );
            return;
          }

          btn.innerHTML =
            '<div class="loading-spinner mr-2"></div> Getting AI Suggestions...';
          btn.disabled = true;

          try {
            // Simulate AI API call (replace with actual implementation)
            await new Promise((resolve) => setTimeout(resolve, 2000));

            // Mock suggestions based on input
            let suggestions = "";
            const input = (title + " " + description).toLowerCase();

            if (input.includes("pothole") || input.includes("road")) {
              suggestions =
                "Suggested category: Road Maintenance\nPriority: Medium\nEstimated resolution time: 5-10 business days\n\nTips for better reporting:\n• Include exact street address\n• Note if it affects traffic flow\n• Mention approximate size of the pothole";
            } else if (input.includes("light") || input.includes("street")) {
              suggestions =
                "Suggested category: Street Lighting\nPriority: High (safety concern)\nEstimated resolution time: 2-5 business days\n\nTips for better reporting:\n• Include pole number if visible\n• Note if multiple lights are affected\n• Mention if it creates safety hazards";
            } else if (input.includes("tree") || input.includes("branch")) {
              suggestions =
                "Suggested category: Parks & Recreation\nPriority: Varies based on safety risk\nEstimated resolution time: 3-7 business days\n\nTips for better reporting:\n• Assess if it poses immediate danger\n• Include approximate tree size\n• Note proximity to power lines or structures";
            } else {
              suggestions =
                "Suggested category: General Maintenance\nPriority: Medium\nEstimated resolution time: 5-15 business days\n\nTips for better reporting:\n• Be as specific as possible about the location\n• Include photos if available\n• Describe how it affects the community";
            }

            // Update description with suggestions
            const currentDesc = document.getElementById("description").value;
            if (currentDesc && !currentDesc.includes("AI Suggestions:")) {
              document.getElementById("description").value =
                currentDesc + "\n\n=== AI Suggestions ===\n" + suggestions;
            } else if (!currentDesc) {
              document.getElementById("description").value =
                "=== AI Suggestions ===\n" +
                suggestions +
                "\n\n[Please add your detailed description above]";
            }

            // Flash the textarea to show it was updated
            const textarea = document.getElementById("description");
            textarea.style.background = "rgba(245, 158, 11, 0.1)";
            setTimeout(() => {
              textarea.style.background = "";
            }, 1000);
          } catch (error) {
            alert(
              "Sorry, AI suggestions are not available right now. Please try again later."
            );
          } finally {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
          }
        });

      // Form submission with validation
      document
        .getElementById("issueForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const title = document.getElementById("title").value.trim();
          const description = document
            .getElementById("description")
            .value.trim();
          const location = document.getElementById("location").value.trim();

          if (!title || !description) {
            alert("Please fill in both title and description fields.");
            return;
          }

          if (!location) {
            const confirmSubmit = confirm(
              "No location has been selected. Would you like to submit anyway?"
            );
            if (!confirmSubmit) {
              return;
            }
          }

          const submitBtn = document.getElementById("submit-btn");
          const originalHtml = submitBtn.innerHTML;

          submitBtn.innerHTML =
            '<div class="loading-spinner mr-2"></div> Submitting Report...';
          submitBtn.disabled = true;

          // Simulate form submission (replace with actual form submission)
          setTimeout(() => {
            alert(
              "Thank you! Your issue report has been submitted successfully. You will receive a confirmation email shortly."
            );

            // Reset form
            this.reset();
            document.getElementById("photo-preview").innerHTML = "";
            document.getElementById("video-preview").innerHTML = "";
            document.getElementById("location-display").style.display = "none";
            if (marker) {
              map.removeLayer(marker);
            }

            submitBtn.innerHTML = originalHtml;
            submitBtn.disabled = false;

            // Optionally redirect to confirmation page
            // window.location.href = '/report-confirmation';
          }, 2000);
        });

      // Smooth scroll for map selection
      document
        .getElementById("selectOnMap")
        .addEventListener("click", function () {
          document.getElementById("osm-map").scrollIntoView({
            behavior: "smooth",
            block: "center",
          });
        });

      // Add some interactive map features
      map.on("moveend", function () {
        // Optional: Update something when map is moved
      });

      // Update footer year
      document.getElementById("year").textContent = new Date().getFullYear();

      // Add some nice loading states for the map
      map.whenReady(function () {
        // Add a subtle animation to show the map is ready
        document.getElementById("osm-map").style.opacity = "0";
        document.getElementById("osm-map").style.transform = "scale(0.95)";

        setTimeout(() => {
          document.getElementById("osm-map").style.transition = "all 0.5s ease";
          document.getElementById("osm-map").style.opacity = "1";
          document.getElementById("osm-map").style.transform = "scale(1)";
        }, 100);
      });

      // Add some visual feedback for form interactions
      document.querySelectorAll(".form-input").forEach((input) => {
        input.addEventListener("focus", function () {
          this.parentElement.parentElement.style.transform = "translateY(-2px)";
        });

        input.addEventListener("blur", function () {
          this.parentElement.parentElement.style.transform = "translateY(0)";
        });
      });

      // Enhanced file upload visual feedback
      document.querySelectorAll(".file-upload-area").forEach((area) => {
        area.addEventListener("click", function () {
          this.style.transform = "scale(0.98)";
          setTimeout(() => {
            this.style.transform = "scale(1)";
          }, 150);
        });
      });
    </script>
  </body>
</html>
